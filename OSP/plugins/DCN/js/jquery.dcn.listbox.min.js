!function(a){function c(b){return{listbox:a(b)}}function d(b){var c=a.data(b,"listbox").options,d=[];return c&&a(">span",b).each(function(){var b={};b[c.valueField]=void 0!=a(this).attr("value")?a(this).attr("value"):a(this).html(),b[c.textField]=a(this).html(),d.push(b)}),d}function e(c,d){var e,g,h;if(b=!0,e=a.data(c,"listbox").options,g=a(c),a.data(c,"listbox").data=[],g.html(""),g.removeClass("listbox"),g.addClass("listbox"),d&&e&&(g.css("width",e.width+"px"),d.length>0))for(h=0;h<d.length;h++)f(c,d[h]);e.onLoadSuccess.call(c,d),b=!1}function f(b,c,d){var i,j,l,m,n,e=a.data(b,"listbox").options,f=a.data(b,"listbox").data,h=a(b);if(e&&h){if(i=c[e.valueField],j=c[e.textField],(void 0==f||null==f)&&(f=[]),e.single)for(l=0;l<f.length;l++)if(f[l][e.valueField]==i)return;if(d=d?!0:e.removeable,m=a('<div class="listbox-item"></div>').appendTo(h),m.hover(function(){a(this).addClass("listbox-item-hover")},function(){a(this).removeClass("listbox-item-hover")}),d&&a('<a class="listbox-item-close" href="javascript:void(0);"></a>').appendTo(m).hover(function(){a(this).addClass("listbox-item-close-hover")},function(){a(this).removeClass("listbox-item-close-hover")}).click(function(){var c=this;a.each(h.find("div.listbox-item"),function(d){return this==a(c).parent()[0]?(g(b,d),!0):void 0})}),m=a('<span class="listbox-item-text"></span>').appendTo(m),m.attr("value",i),e.formatter)try{n=a(e.formatter.call(b,c)),n.length>0&&n.children().length>0?(m.children().remove(),a(e.formatter.call(b,c)).appendTo(m)):m.html(e.formatter.call(b,c))}catch(o){m.html(e.formatter.call(b,c))}else m.html(j);f.push(c),a.data(b,"listbox").data=f,e.required&&k(b,!0),e.onAddItem.call(f.length-1,c)}}function g(b,c){var g,d=a.data(b,"listbox").data,e=a.data(b,"listbox").options,f=a(b);d&&f&&e&&(g=f.find("div.listbox-item"),g.length>c&&d.length>c&&e.onBeforeRemoveItem.call(b,c)&&(d.splice(c,1),a(g[c]).remove(),e.required&&k(b,!0),e.onRemoveItemSuccess.call(b,c)))}function h(b){var c,d;a.data(b,"listbox").data=[],c=a.data(b,"listbox").options,d=a(b),d&&c&&(d.empty(),k(b,!1))}function i(b){var c=[],d=a.data(b,"listbox").options,e=a.data(b,"listbox").data;return e&&d&&a.each(e,function(){c.push(this[d.valueField])}),c}function j(b){var c=[],d=a.data(b,"listbox").options,e=a.data(b,"listbox").data;return e&&d&&a.each(e,function(){c.push(this[d.textField])}),c}function k(c,d){var f,e=a.data(c,"listbox").options;if(e){if(f=i(c),d&&e.required&&!f.length>0)return a(c).addClass("listbox-required"),b||(a(c).tooltip("destroy").tooltip({content:e.missingMessage}).tooltip("show"),a.parser.parse(a(c))),!1;a(c).removeClass("listbox-required").tooltip("destroy")}return!0}var b=!0;a.fn.listbox=function(b,f,g){return"string"==typeof b?a.fn.listbox.methods[b](this,f,g):(b=b||{},this.each(function(){var h,f=a.data(this,"listbox"),g=[];f?(a.extend(f.options,b),void 0!=b.data&&e(this,b.data)):(h=c(this),f=a.data(this,"listbox",{options:a.extend({},a.fn.listbox.defaults,a.fn.listbox.parseOptions(this),b),listbox:h.listbox,previousValue:null}),g=d(this),f.options.data&&(g=f.options.data),e(this,g))}))},a.fn.listbox.methods={options:function(b){return a.data(b[0],"listbox").options},validate:function(a){return a.each(function(){k(this,!0)})},isValid:function(a){return k(a[0],!0)},getData:function(b){return a.data(b[0],"listbox").data},getText:function(a){var b=j(a[0]);return b[0]},getTexts:function(a){return j(a[0])},getValue:function(a){var b=i(a[0]);return b[0]},getValues:function(a){return i(a[0])},addItem:function(a,b,c){return a.each(function(){f(this,b,c)})},addItemList:function(b,c,d){return a.each(c,function(){f(b[0],this,d)})},removeItem:function(a,b){return a.each(function(){g(this,b)})},removeAllItem:function(b){return b.each(function(){for(var b=this;a(b).listbox("getData").length>0;)g(b,0)})},reset:function(a){return a.each(function(){h(this)})}},a.fn.listbox.parseOptions=function(b){var c=a(b);return a.extend({},a.parser.parseOptions(b,["valueField","textField","missingMessage"]),{multiple:c.attr("multiple")?!0:void 0,disabled:c.attr("disabled")?!0:void 0,required:c.attr("required")?!0:void 0,removeable:void 0==c.attr("removeable")?!0:c.attr("removeable"),single:void 0==c.attr("single")?!0:c.attr("single"),width:parseInt(c.attr("width")?c.attr("width"):550)})},a.fn.listbox.defaults={width:630,valueField:"value",textField:"text",disabled:!1,required:!1,removeable:!0,single:!0,missingMessage:"该输入项为必输项",data:null,formatter:function(b){var c=a(this).listbox("options");return b[c.textField]},onLoadSuccess:function(){},onAddItem:function(){},onBeforeRemoveItem:function(){return!0},onRemoveItemSuccess:function(){}}}(jQuery);