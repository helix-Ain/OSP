<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title></title>

    <script src="../JS/jquery-1.8.3.min.js" type="text/javascript"></script>

    <script type='text/javascript' src='js/Constants.js'></script>

    <script type="text/javascript" src="../JS/CommonScript.js?script=../Platform/JS/SearchOrg.js,../js/PlatformSearch.js,js/CurrCommonScript.js,../plugins/DCN/jquery.dcnplugins.js"></script>

</head>
<body style="display: none;">
    <div id="div_Body" class="easyui-tabs" data-options="fit:true">
        <div title="基本资料">
            <div id="div_Detail" class="easyui-layout" data-options="fit:true,border:false">
                <div data-options="region:'center',border:false">
                    <form id="form_Edit" method="post" novalidate="novalidate" action="">
                    <table style="min-width: 300px;" class="TableCenter">
                        <tr id="tr_Org" style="display: none;">
                            <td class="tabletext">
                                组织名：
                            </td>
                            <td class="tableinput">
                                <input id="ddl_Org" name="iOrgID" class="easyui-combogrid" data-options="width:150" />
                            </td>
                        </tr>
                        <tr>
                            <td class="tabletext">
                                角色类型：
                            </td>
                            <td class="tableinput">
                                <input id="ddl_Type" name="iType" class="easyui-combobox" data-options="editable:false,width:150,required:true" />
                            </td>
                        </tr>
                        <tr>
                            <td class="tabletext">
                                角色编号：
                            </td>
                            <td class="tableinput">
                                <input type="text" name="cGroupCode" class="easyui-validatebox" data-options="required:true" />
                            </td>
                        </tr>
                        <tr>
                            <td class="tabletext">
                                角色中文名：
                            </td>
                            <td class="tableinput">
                                <input type="text" name="cGroupChiName" class="easyui-validatebox" data-options="required:true" />
                            </td>
                        </tr>
                        <tr>
                            <td class="tabletext">
                                角色英文名：
                            </td>
                            <td class="tableinput">
                                <input type="text" name="cGroupEngName" class="TextEdit" />
                            </td>
                        </tr>
                        <tr>
                            <td class="tabletext">
                                角色可用文件空间：
                            </td>
                            <td class="tableinput">
                                <input name="iStorageSpace" type="text" class="easyui-numberbox TextEdit" data-options="min:0,precision:0"></input>
                                MB
                            </td>
                        </tr>
                        <tr>
                            <td class="tabletext">
                                角色邮箱可用空间：
                            </td>
                            <td class="tableinput">
                                <input name="iMailboxCapacity" type="text" class="easyui-numberbox TextEdit" data-options="min:0,precision:0"></input>
                                MB
                            </td>
                        </tr>
                        <tr>
                            <td class="tabletext">
                                可见：
                            </td>
                            <td class="tableinput">
                                <input id="chk_Display" type="checkbox" name="bIsDisplay" />
                            </td>
                        </tr>
                        <tr>
                            <td class="tabletext">
                                接收短信：
                            </td>
                            <td class="tableinput">
                                <input id="chk_SMSType" type="checkbox" />
                            </td>
                        </tr>
                    </table>
                    </form>
                </div>
                <div data-options="region:'south',border:false" style="height: 35px; overflow: hidden;">
                    <div class="ButtonBar" style="position: inherit; min-width: 150px;">
                        <a href="javascript:void(0)" class="easyui-linkbutton" onclick="saveData()">保存</a>
                        <a href="javascript:void(0)" class="easyui-linkbutton" onclick="cancelSelf();">关闭</a>
                    </div>
                </div>
            </div>
        </div>
        <div title="用户列表">
            <div class="easyui-layout" data-options="fit:true,border:false">
                <div data-options="region:'north',border:false,title:'查询条件',iconCls:'dc-icon-search'"
                    style="height: 80px;">
                    <ul class="searchForm1">
                        <li>
                            <input name="cLoginName" type="text" class="dc-search dc-input" dc-tip="请输入登录ID" />
                        </li>
                        <li>
                            <input name="cUserChiName" type="text" class="dc-search dc-input" dc-tip="请输入用户名" />
                        </li>
                        <li>
                            <input name="cEmail" type="text" class="dc-search dc-input" dc-tip="请输入邮箱" />
                        </li>
                        <li><a href="javascript:void(0)" onclick="searchData()" class="dc-button">查询</a></li>
                    </ul>
                </div>
                <div data-options="region:'center',border:false">
                    <table id="tab_User_List" style="display: none;">
                        <thead>
                            <tr>
                                <th data-options="field:'ck',checkbox:true">
                                </th>
                                <th data-options="field:'btn',fixed:true,resizable:false,formatter: function(value,row,index){return getDetailButton(row.iID,'user_EditData');}">
                                    <div style="width: 50px; height: 5px; display: block;">
                                    </div>
                                </th>
                                <th data-options="field:'cLoginName',width:80,sortable:true">
                                    登录ID
                                </th>
                                <th data-options="field:'cUserChiName',width:80,sortable:true">
                                    用户名
                                </th>
                                <th data-options="field:'cEmail',width:140,sortable:true">
                                    邮箱
                                </th>
                                <th data-options="field:'cOrgName',width:100,sortable:true">
                                    权限所在组织
                                </th>
                            </tr>
                        </thead>
                    </table>
                    <div id="div_User_Toolbar" class="GridButtonBar" style="display: none;">
                        <span class="GridButtonBarIco"></span><a href="javascript:void(0)" class="easyui-linkbutton"
                            iconcls="dc-icon-pencil" plain="true" onclick="user_SearchUser()">添加</a> <a href="javascript:void(0)"
                                class="easyui-linkbutton" iconcls="dc-icon-pencil" plain="true" onclick="user_DeleteData()">
                                删除</a>
                    </div>
                </div>
                <div data-options="region:'south',border:false" style="height: 35px; overflow: hidden;">
                    <div class="ButtonBar" style="position: inherit; min-width: 150px;">
                        <a href="javascript:void(0)" class="easyui-linkbutton" onclick="cancelSelf();">关闭</a>
                    </div>
                </div>
            </div>
            <div id="div_User_SelectOrg" class="easyui-dialog" data-options="closed:true,modal:true,border:false,iconCls:'dc-icon-dialog-title'">
                <form id="form_User_SelectOrg" method="post" novalidate="novalidate" action="">
                <table style="width: 100%;" class="TableCenter">
                    <tr group="User_Edit">
                        <td class="tabletext">
                            登录ID：
                        </td>
                        <td class="tableinput">
                            <input id="txt_User_LoginName" type="text" name="cLoginName" class="TextEdit" />
                        </td>
                    </tr>
                    <tr group="User_Edit">
                        <td class="tabletext">
                            用户名：
                        </td>
                        <td class="tableinput">
                            <input id="txt_User_UserChiName" type="text" name="cUserChiName" class="TextEdit" />
                        </td>
                    </tr>
                    <tr>
                        <td class="tabletext">
                            权限所在组织：
                        </td>
                        <td class="tableinput">
                            <input id="ddl_User_OrgID" name="iOrgID" class="easyui-combogrid" data-options="width:150,required:true" />
                        </td>
                    </tr>
                </table>
                </form>
                <div class="ButtonBar">
                    <a id="btn_User_Save" href="javascript:void(0)" class="easyui-linkbutton">保存</a>
                    <a href="javascript:void(0)" class="easyui-linkbutton" onclick="user_Cancel();">关闭</a>
                </div>
            </div>
        </div>
        <div title="授权设置">
        </div>
        <div title="桌面设置">
        </div>
        <div title="快捷菜单设置">
        </div>
        <div title="手机模块设置">
        </div>
    </div>
</body>
</html>

<script language="javascript" type="text/javascript">
    var _strAction = "";
    var _strFun = '';
    var _iID = 0;
    var _iOrgID = 0;
    var user_iOrgID = 0;
    var _bUserGetData = false;

    initReady(function() {
        setControlEnable('txt_User_LoginName', false);
        setControlEnable('txt_User_UserChiName', false);
        $("#ddl_Org").combogrid({ onShowPanel: function() { setOrgComboGrid("#ddl_Org"); } });
        $("#ddl_User_OrgID").combogrid({ onShowPanel: function() { setOrgComboGrid("#ddl_User_OrgID"); } });
        $('#div_User_SelectOrg').dialog({ onBeforeClose: function() { $(".tooltip").remove(); } });

        _strAction = getHashValue("Action");
        if (_strAction == "new") {
            newData();
        }
        else {
            $('#ddl_Org').combogrid('disable');
            $('#ddl_Type').combobox('disable');
        }

        _strFun = getHashValue("Fun");
        if (_strFun != '') {
            _strFun += '(m_iID)';
        }

        $('#div_Body').tabs({
            onSelect: function(title, index) {
                if (index == 1 && !_bUserGetData) {
                    user_GetData();
                }
                var m_obj = $('#div_Body').tabs('getTab', index);
                if ($.trim(m_obj.html()) == '') {
                    switch (index) {
                        case 2:
                            m_obj.panel('refresh', '../BSM/UserGroupPowerManage.html');
                            $('#div_Body').tabs('resize');
                            break;
                        case 3:
                            m_obj.panel('refresh', '../BSM/UserGroupDesktop.html');
                            $('#div_Body').tabs('resize');
                            break;
                        case 4:
                            m_obj.panel('refresh', '../BSM/UserGroupQuickMenu.html');
                            $('#div_Body').tabs('resize');
                            break;
                        case 5:
                            m_obj.panel('refresh', '../BSM/UserGroupMobile.html');
                            $('#div_Body').tabs('resize');
                            break;
                    }
                }
            }
        });
    });

    checkPagePower({ onload: function() { initPage(); }, showMask: false });

    function initPage() {
        $('#div_Body').tabs('resize');
        if (_strAction != "add") {
            _iID = getHashValue("UserGroupID");
            if (_iID > 0) {
                editData();
            }
        }
    }

    function cancelSelf() {
        try {
            parent.cancel();
        }
        catch (err) {
            $('body').css('display', 'none');
        }
    }

    function cancel() {
        closedPopupDialog();
    }

    function newData() {
        _strAction = "add";
        $("#div_Detail").appendTo("body")
        $("#div_Body").remove();

        var m_iType = parseInt(getHashValue("Type"));
        if (m_iType == 2) {
            $('#tr_Org').css('display', '');
            $('#ddl_Org').combogrid({ required: true });
        }
        bindCodeMasterData({
            controlID: "ddl_Type",
            cat: "ugm",
            subCat: "Type",
            valueField: "cCodeItem",
            success: function() {
                $('#ddl_Type').combobox('select', m_iType).combobox('disable');
            }
        });

        $("#chk_Display").attr("checked", true);
        $.parser.parse();
    }

    function editData() {
        _strAction = "update";
        if (_iID > 0) {
            postData({
                url: "DcCdUserGroupManage",
                params: { Action: "GetAllList", iUserGroupID: _iID },
                isSys: true,
                success: function(ci_result) {
                    if (existData(ci_result)) {
                        var m_objData = ci_result.rows[0];

                        _iOrgID = m_objData.iOrgID;
                        $('#form_Edit').form('load', m_objData);

                        $("#ddl_Org").combogrid('setValue', m_objData.iOrgID).combogrid('setText', m_objData.cOrgName);

                        $("#chk_Display").attr("checked", m_objData.bIsDisplay);
                        $('#chk_SMSType').attr('checked', (m_objData.iSMSType == 2 ? true : false));

                        $('#ddl_Type').combobox({
                            valueField: 'id',
                            textField: 'text',
                            data: [{ id: m_objData.iType, text: m_objData.cTypeDesc}]
                        });

                        $('#ddl_Type').combobox('select', m_objData.iType).combobox('disable');

                        if (m_objData.iType == 2) {
                            $('#tr_Org').css('display', '');
                        }
                    }
                    else {
                        $.messager.alert('提示', '记录不存在或已删除', 'info', function() { cancelSelf(); });
                    }
                }
            });
        }
        else {
            $.messager.alert('提示', '记录不存在或已删除', 'info', function() { cancelSelf(); });
        }
    }

    function saveData() {
        postData({
            url: 'DcCdUserGroupManage',
            isSys: true,
            params: { Action: _strAction, iUserGroupID: _iID },
            validate: true,
            form: 'form_Edit',
            onPost: function() {
                this.params.iSMSType = ($('#chk_SMSType').attr('checked') ? 2 : 1);
                return true;
            },
            success: function(ci_result) {
                var m_iID = 0;
                if (_strAction == 'add') {
                    if (existData(ci_result)) {
                        m_iID = ci_result.rows[0].iUserGroupID;
                        location.hash = '#ID=' + m_iID + '&Fun=' + _strFun;
                        setTimeout(function() {
                            location.reload();
                        }, 500);
                    }
                }
                else {
                    $.messager.alert('提示', '保存成功', 'info');
                }
                if (_strFun != '') {
                    eval(_strFun);
                }
            }
        });
    }

    function user_GetData() {
        if (_iID > 0) {
            setDataGrid('tab_User_List', 'div_User_Toolbar', 'DcCdUserGroupMappingManage', getSearchParameter(true), "iID", "cLoginName", '', {
                singleSelect: false,
                checkOnSelect: true,
                selectOnCheck: true,
                onClickRow: function(rowIndex, rowData) { $("#tab_User_List").datagrid("unselectAll").datagrid("selectRow", rowIndex); },
                onDblClickRow: function(rowIndex, rowData) { $("#tab_User_List").datagrid("selectRow", rowIndex); user_EditData(rowData.iID); }
            }, true);
        }
        _bUserGetData = true;
    }

    function user_SearchUser() {
        user_iOrgID = -1;
        if (_iOrgID > 0) {
            user_iOrgID = _iOrgID;
            platform_openSearchRefRecord(3, 'parent.user_ReadData', 'type=1&iNUserGroupID=' + _iID + '&iNOrgID=' + user_iOrgID);
        }
        else {
            $('[group="User_Edit"]').css('display', 'none');
            $('#form_User_SelectOrg').form('clear');
            $('#div_User_SelectOrg').dialog({ title: '选择组织', width: 300, height: 200 }).dialog('open');
            $('#btn_User_Save').linkbutton({ text: '确定' });

            $('#btn_User_Save').unbind("click").bind("click", function() {
                if ($('#form_User_SelectOrg').form('validate')) {
                    user_Cancel();
                    user_iOrgID = parseInt($('#ddl_User_OrgID').combogrid('getValue'));
                    platform_openSearchRefRecord(3, 'parent.user_ReadData', 'type=1&iNUserGroupID=' + _iID + '&iOrgID=' + user_iOrgID);
                }
            });
        }

    }

    function user_ReadData(ci_strData) {
        closedPopupDialog();
        if (ci_strData != '') {
            var m_strSign = getSeparativeSign();
            var m_objUserID = [];
            $.each(ci_strData.split(','), function(index, value) {
                var m_iUserID = parseInt(value);
                if (m_iUserID > 0) {
                    m_objUserID.push(_iID + m_strSign + m_iUserID + m_strSign + user_iOrgID);
                }
            });
            user_iOrgID = -1;
            if (m_objUserID.length > 0) {
                $.messager.confirm('提示', '确定要添加所选的' + m_objUserID.length + '条记录吗？', function(r) {
                    if (r) {
                        postData({
                            url: "DcCdUserGroupMappingManage",
                            isSys: true,
                            params: { Action: "Add", DetailData: m_objUserID.join(m_strSign + ',' + m_strSign) },
                            success: function(ci_result) {
                                $('#tab_User_List').datagrid('reload');
                            }
                        });
                    }
                });
            }
        }
    }

    function user_Cancel() {
        $('#div_User_SelectOrg').dialog('close');
    }

    function user_AddData(ci_iOrgID, ci_objData) {
        if (ci_iOrgID > 0 && ci_objData.length > 0) {
            $.messager.confirm('提示', '确定要添加所选的' + ci_objData.length + '条记录吗？', function(r) {
                if (r) {
                    postData({
                        url: "DcCdUserGroupMappingManage",
                        isSys: true,
                        params: { Action: "Add" },
                        onPost: function() {
                            var m_objData = [];
                            var m_strSign = getSeparativeSign();
                            $.each(ci_objData, function() {
                                m_objData.push(_iID + m_strSign + this + m_strSign + ci_iOrgID);
                            });
                            this.params.DetailData = m_objData.join(m_strSign + ',' + m_strSign)
                            return true;
                        },
                        success: function(ci_result) {
                            $('#tab_User_List').datagrid('reload');
                        }
                    });
                }
            });
        }
    }

    function user_EditData(ci_iID) {
        if (ci_iID > 0) {
            setTimeout(function() {
                var m_objData = $('#tab_User_List').datagrid('getSelected');
                if (m_objData != null) {
                    $('[group="User_Edit"]').css('display', '');
                    $('#form_User_SelectOrg').form('clear').form('load', m_objData);
                    $("#ddl_User_OrgID").combogrid('setValue', m_objData.iOrgID).combogrid('setText', m_objData.cOrgName);
                    if (_iOrgID > 0) {
                        $("#ddl_User_OrgID").combogrid('disable');
                    }
                    $('#div_User_SelectOrg').dialog({ title: '修改组织', width: 300, height: 200 }).dialog('open');

                    $('#btn_User_Save').unbind("click").bind("click", function() {
                        postData({
                            url: 'DcCdUserGroupMappingManage',
                            params: { Action: 'Update', iID: m_objData.iID, iUserID: m_objData.iUserID, iUserGroupID: m_objData.iUserGroupID },
                            form: 'form_User_SelectOrg',
                            validate: true,
                            success: function(ci_result) {
                                user_Cancel();
                                $('#tab_User_List').datagrid('reload');
                                $.messager.alert('提示', '保存成功', 'info');
                            }
                        });
                    });
                }
                else {
                    $.messager.alert('提示', '请选择记录', 'info');
                }
            }, 100);
        }
        else {
            $.messager.alert('提示', '请选择记录', 'info');
        }

    }

    function user_DeleteData() {
        var m_row = $('#tab_User_List').datagrid('getChecked');
        if (m_row.length > 0) {
            $.messager.confirm('提示', '确定要删除所选' + m_row.length + '条记录吗？', function(r) {
                if (r) {
                    var m_arrID = [];
                    $.each(m_row, function(index, value) { m_arrID[index] = value.iID; });
                    postData({
                        url: "DcCdUserGroupMappingManage",
                        params: { iID: m_arrID.join(","), Action: "Delete" },
                        success: function(ci_result) {
                            $('#tab_User_List').datagrid('reload');
                            $.messager.alert('提示', '删除成功', 'info');
                        }
                    });
                }
            });
        }
        else {
            $.messager.alert('提示', '请选择记录', 'info');
        }
    }

    function getSearchParameter(ci_bIsBase) {
        var m_objParams = { Action: "query", "iUserGroupID": _iID, Type: 'A' };
        if (!ci_bIsBase) {
            return getSearchParameters($(".searchForm1"), m_objParams);
        }
        return m_objParams;
    }

    function searchData() {
        $("#tab_User_List").datagrid("load", getSearchParameter());
    }
</script>

